# Description: Ansible playbook for restarting a systemd service.
# Description: Restarts the named service and verifies it comes back healthy.
#
# Extra variables:
#   target_host  - Host or group to target (used via --limit)
#   service_name - Name of the systemd service to restart (required)
---
- name: Service restart remediation
  hosts: all
  become: true

  pre_tasks:
    - name: Validate service_name is provided
      ansible.builtin.assert:
        that:
          - service_name is defined
          - service_name | length > 0
        fail_msg: "service_name variable is required"

  tasks:
    - name: Check service status before restart
      ansible.builtin.systemd:
        name: "{{ service_name }}"
      register: service_before
      ignore_errors: true

    - name: Display pre-restart status
      ansible.builtin.debug:
        msg: "Service {{ service_name }} state: {{ service_before.status.ActiveState | default('unknown') }}"

    - name: Restart the service
      ansible.builtin.systemd:
        name: "{{ service_name }}"
        state: restarted
        daemon_reload: true

    - name: Wait for service to stabilize
      ansible.builtin.pause:
        seconds: 5

    - name: Verify service is running
      ansible.builtin.systemd:
        name: "{{ service_name }}"
      register: service_after
      failed_when: service_after.status.ActiveState != "active"

    - name: Display post-restart status
      ansible.builtin.debug:
        msg: "Service {{ service_name }} is {{ service_after.status.ActiveState }} (PID: {{ service_after.status.MainPID | default('N/A') }})"
